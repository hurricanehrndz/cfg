#!/bin/bash
width=${2:-80%}
height=${2:-80%}
TMUX_INFO="$(tmux display-message -p -F "#{window_id}.#{pid}.#{session_id}:#{session_name}")"
TMUX_SESSION_NAME="${TMUX_INFO##*:}"
TMUX_UNIQUE_ID="${TMUX_INFO%%:*}"
TMUX_UNIQUE_ID="${TMUX_UNIQUE_ID//\$/}"
NVIM_SOCKET="/tmp/nvim.${USER}/${TMUX_UNIQUE_ID}"
popup_session_name="popup_${SOCKET_INFO}"

read -r -d '' tmux_popup_cmd <<-EOF
tmux new-session -A -s $popup_session_name \; \
setenv NVIM $NVIM_SOCKET \; \
setenv TMUX_POPUP 1 \;
EOF

if [[ ${TMUX_SESSION_NAME} =~ "popup" ]]; then
    tmux detach-client
else
    tmux display-popup \
        -xC -yC \
        -w"$width" -h"$height" \
        -d "#{pane_current_path}" \
        -E "$tmux_popup_cmd"
fi
